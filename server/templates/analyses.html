{% extends "base.html" %}
{% block content %}

<!-- Active / Pending Jobs Summary -->
<div class="metrics-grid" style="margin-bottom: 2rem;">
  <div class="metric">
    <strong>Queue Depth</strong>
    <span>{{ games|selectattr("analysis_status.value", "in", ["queued", "pending"])|list|length }}</span>
  </div>
  <div class="metric">
    <strong>Flagged Today</strong>
    <span>{{ games|selectattr("analysis_status.value", "equalto", "flagged")|list|length }}</span>
  </div>
</div>

<!-- Active Analyses Grid -->
{% set active_games = games|selectattr("analysis_status.value", "in", ["queued", "pending", "analyzing"])|list %}
{% if active_games %}
<div style="margin-bottom: 2rem;">
  <h3 style="margin-bottom: 1rem;">ðŸ”„ Active Analyses</h3>
  <div class="metrics-grid" style="grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));">
    {% for game in active_games %}
    <div class="metric"
      style="display: flex; flex-direction: column; gap: 0.5rem; position: relative; overflow: hidden;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <strong>#{{ game.id }}</strong>
        <span class="badge badge-warning">RUNNING</span>
      </div>
      <div style="font-size: 1rem;">
        {{ game.white_player.username }} <span style="opacity:0.5; font-size:0.8rem;">vs</span> {{
        game.black_player.username }}
      </div>

      <!-- Fake Progress Bar -->
      <div style="margin-top: 0.5rem; background: rgba(255,255,255,0.1); height: 4px; width: 100%; border-radius: 2px;">
        <div
          style="background: var(--accent-primary); height: 100%; width: 60%; border-radius: 2px; animation: pulse 1.5s infinite;">
        </div>
      </div>
      <small style="margin-top: 0.25rem; opacity: 0.7;">Analysing moves...</small>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<div class="card">
  <div class="card-header"
    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h3>Recent Analyses</h3>
    <div class="controls">
      <form method="get" style="display: flex; gap: 0.5rem; margin: 0;">
        <input type="text" name="search" placeholder="Search player..." value="{{ search_filter or '' }}"
          style="padding: 0.5rem; border-radius: 6px; background: var(--bg-primary); color: white; border: 1px solid var(--border-default); width: 200px;">
        <select name="status" onchange="this.form.submit()"
          style="padding: 0.5rem; border-radius: 6px; background: var(--bg-primary); color: white; border: 1px solid var(--border-default);">
          <option value="">All Statuses</option>
          {% for status in status_options %}
          <option value="{{ status }}" {% if status_filter==status %}selected{% endif %}>{{ status }}</option>
          {% endfor %}
        </select>
        <noscript><button type="submit">Go</button></noscript>
      </form>
    </div>
  </div>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>White</th>
          <th>Black</th>
          <th>Result</th>
          <th>Suspicion</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for game in games %}
        <tr>
          <td>{{ game.played_at.strftime('%Y-%m-%d') if game.played_at else '-' }}</td>
          <td>
            <a href="/player/{{ game.white_player.username }}"
              style="color: white; text-decoration: none; font-weight: 500;">
              {{ game.white_player.username }}
            </a>
          </td>
          <td>
            <a href="/player/{{ game.black_player.username }}"
              style="color: white; text-decoration: none; font-weight: 500;">
              {{ game.black_player.username }}
            </a>
          </td>
          <td><span class="badge" style="background: rgba(255,255,255,0.05);">{{ game.result }}</span></td>
          <td>
            {% if game.investigation and game.investigation.details %}
            {% set score = game.investigation.details.get('suspicion_score', 0) %}
            {% if score > 0.8 %}
            <span class="badge badge-danger">{{ "%.2f"|format(score) }}</span>
            {% elif score > 0.5 %}
            <span class="badge badge-warning">{{ "%.2f"|format(score) }}</span>
            {% else %}
            <span style="opacity: 0.5;">{{ "%.2f"|format(score) }}</span>
            {% endif %}
            {% else %}
            <span style="opacity: 0.3;">-</span>
            {% endif %}
          </td>
          <td>
            {% if game.analysis_status.value == 'flagged' %}
            <span class="badge badge-danger">FLAGGED</span>
            {% elif game.analysis_status.value == 'completed' %}
            <span class="badge badge-success">CLEAN</span>
            {% elif game.analysis_status.value == 'analyzing' %}
            <span class="badge badge-warning">ANALYZING</span>
            {% else %}
            <span class="badge">{{ game.analysis_status.value }}</span>
            {% endif %}
          </td>
          <td>
            <a href="/analyses/{{ game.id }}" class="button secondary"
              style="padding: 0.25rem 0.75rem; font-size: 0.75rem; height: auto;">View</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}